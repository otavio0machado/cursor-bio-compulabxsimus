{
    "name": "Detetive - Relat√≥rio Semanal (Sexta 17h)",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "cronExpression",
                            "expression": "0 17 * * 5"
                        }
                    ]
                }
            },
            "id": "cron-semanal",
            "name": "Cron Sexta 17h",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                240,
                320
            ]
        },
        {
            "parameters": {
                "method": "GET",
                "url": "={{ $env.SUPABASE_URL }}/rest/v1/divergencias?select=*&created_at=gte.{{ $now.minus(7, 'days').toISODate() }}",
                "authentication": "predefinedCredentialType",
                "nodeCredentialType": "httpHeaderAuth",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "apikey",
                            "value": "={{ $env.SUPABASE_KEY }}"
                        },
                        {
                            "name": "Authorization",
                            "value": "Bearer {{ $env.SUPABASE_KEY }}"
                        }
                    ]
                }
            },
            "id": "fetch-semana",
            "name": "Buscar Diverg√™ncias 7 dias",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                460,
                320
            ]
        },
        {
            "parameters": {
                "jsCode": "const items = $input.all();\nlet totalPerda = 0;\nlet countDiv = 0;\nconst porConvenio = {};\nconst porDia = {};\n\nfor (const item of items) {\n  const data = item.json;\n  if (Array.isArray(data)) {\n    for (const div of data) {\n      const perda = Math.abs((div.valor_simus || 0) - (div.valor_convenio || 0));\n      totalPerda += perda;\n      countDiv++;\n      \n      const conv = div.convenio || 'Desconhecido';\n      porConvenio[conv] = (porConvenio[conv] || 0) + perda;\n      \n      const dia = (div.created_at || '').substring(0, 10);\n      porDia[dia] = (porDia[dia] || 0) + 1;\n    }\n  }\n}\n\nconst top3Convenios = Object.entries(porConvenio)\n  .sort((a, b) => b[1] - a[1])\n  .slice(0, 3)\n  .map(([nome, valor]) => `   ‚Ä¢ ${nome}: R$ ${valor.toLocaleString('pt-BR')}`)\n  .join('\\n');\n\nconst tendenciaDias = Object.entries(porDia)\n  .sort((a, b) => a[0].localeCompare(b[0]))\n  .map(([dia, count]) => `   ${dia}: ${count} diverg√™ncias`)\n  .join('\\n');\n\nconst formatBRL = (v) => `R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;\n\nconst relatorio = `\nüìä *RELAT√ìRIO SEMANAL - DETETIVE DE DADOS*\nüìÖ Semana de ${new Date(Date.now() - 7*24*60*60*1000).toLocaleDateString('pt-BR')} a ${new Date().toLocaleDateString('pt-BR')}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüí∞ *RESUMO FINANCEIRO*\n   Perda Total: ${formatBRL(totalPerda)}\n   Diverg√™ncias: ${countDiv}\n   M√©dia/Dia: ${formatBRL(totalPerda / 7)}\n\nüèÜ *TOP 3 CONV√äNIOS (Perda)*\n${top3Convenios || '   Nenhum registro'}\n\nüìà *EVOLU√á√ÉO DI√ÅRIA*\n${tendenciaDias || '   Sem dados'}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${totalPerda > 5000 ? '‚ö†Ô∏è *ALERTA:* Perda semanal acima de R$ 5.000!' : '‚úÖ Semana dentro do esperado.'}\n\nüí° *Recomenda√ß√£o:* ${totalPerda > 5000 ? 'Agende reuni√£o com faturamento na segunda-feira.' : 'Manter rotina de monitoramento.'}\n`;\n\nreturn [{ json: { relatorio, totalPerda, countDiv, top3: Object.keys(porConvenio).slice(0, 3) } }];"
            },
            "id": "processar-relatorio",
            "name": "Gerar Relat√≥rio",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                680,
                320
            ]
        },
        {
            "parameters": {
                "operation": "sendMessage",
                "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
                "text": "={{ $json.relatorio }}",
                "additionalFields": {
                    "parse_mode": "Markdown"
                }
            },
            "id": "enviar-relatorio",
            "name": "Enviar Relat√≥rio",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1.2,
            "position": [
                900,
                320
            ],
            "credentials": {
                "telegramApi": {
                    "id": "CONFIGURE",
                    "name": "Telegram API"
                }
            }
        }
    ],
    "connections": {
        "Cron Sexta 17h": {
            "main": [
                [
                    {
                        "node": "Buscar Diverg√™ncias 7 dias",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Buscar Diverg√™ncias 7 dias": {
            "main": [
                [
                    {
                        "node": "Gerar Relat√≥rio",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Gerar Relat√≥rio": {
            "main": [
                [
                    {
                        "node": "Enviar Relat√≥rio",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}